<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RIT CRL Duty Pick</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      transform: scale(0.95);
      transform-origin: top center;
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .left-head, .right-head {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .hint {
      font-size: 12px;
      color: #666;
    }

    select {
      font-size: 16px;
      padding: 5px 10px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      justify-items: center;
    }

    .row-two {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }

    .month {
      background: #fff;
      border: 2px solid #333;
      padding: 10px;
      min-width: 520px; /* ensures stable layout even when blank */
    }

    .month-title {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      min-height: 24px;
    }

    .day-names, .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
    }

    .day-names div {
      font-weight: bold;
      background: #ddd;
      padding: 5px;
    }

    .day {
      background: white;
      border: 1px solid #aaa;
      width: 70px;
      height: 70px;
      position: relative;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      user-select: none;
    }

    .day.blank { /* empty spacer cells before day 1 */
      cursor: default;
      background: #fafafa;
    }

    .overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      font-size: 86px; /* a touch larger */
      font-weight: 900; /* bolder */
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      transform: rotate(45deg);
      line-height: 1;
    }

    .overlay.slash {
      color: rgba(60, 60, 255, 0.78); /* less transparent */
      text-shadow: 0 0 2px rgba(0,0,0,0.15);
    }

    .overlay.x {
      color: rgba(255, 40, 40, 0.78); /* less transparent */
      text-shadow: 0 0 2px rgba(0,0,0,0.15);
    }

    .weekend {
      background-color: rgba(0, 128, 0, 0.12);
    }

    .grayout {
      background-color: #cfcfcf !important;
      color: #777;
    }

    .unclickable {
      /* Allow clicks so Gray Out mode can toggle; normal mode guards in JS */
      pointer-events: auto;
    }

    .mode-indicator {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      border: 1px solid #ccc;
      color: #333;
    }
  </style>
</head>
<body>

  <header>
    <div class="left-head">
      <h1 id="pageTitle">RIT CRL Duty Pick</h1>
      <span id="modeIndicator" class="mode-indicator" style="display:none;"></span>
    </div>
    <div class="right-head">
      <label for="semesterSelect" class="hint">Choose semester:</label>
      <select id="semesterSelect">
        <option selected disabled>— Select Semester —</option>
        <!-- options inserted by JS -->
      </select>

      <select id="actionsDropdown">
        <option disabled selected>Options</option>
        <option value="addWeekends">Add Weekends (toggle mode)</option>
        <option value="grayOut">Gray Out (toggle mode)</option>
        <option value="clear">Clear All Marks (/ and X)</option>
      </select>
    </div>
  </header>

  <div class="calendar-grid" id="topRow"></div>
  <div class="row-two" id="bottomRow"></div>

  <script>
    /************** CONFIG **************/
    const FUTURE_SEMESTER_COUNT = 12; // Spring 2026 through Fall 2031 (12 semesters)
    const STATE_KEYS = {
      marks: "duty_calendar_marks",          // { "YYYY-MM-DD": "", "/", "X" }
      weekendOverrides: "duty_calendar_weekend_overrides", // { "YYYY-MM-DD": true }
      grayouts: "duty_calendar_grayouts"     // { "YYYY-MM-DD": true }
    };

    const states = ["", "/", "X"]; // click cycles; hold Ctrl to clear

    /************** STORAGE **************/
    let markState = JSON.parse(localStorage.getItem(STATE_KEYS.marks) || "{}");
    let weekendOverrides = JSON.parse(localStorage.getItem(STATE_KEYS.weekendOverrides) || "{}");
    let grayouts = JSON.parse(localStorage.getItem(STATE_KEYS.grayouts) || "{}");

    function saveMarks()   { localStorage.setItem(STATE_KEYS.marks, JSON.stringify(markState)); }
    function saveWends()   { localStorage.setItem(STATE_KEYS.weekendOverrides, JSON.stringify(weekendOverrides)); }
    function saveGrayouts(){ localStorage.setItem(STATE_KEYS.grayouts, JSON.stringify(grayouts)); }

    /************** SEMESTERS **************/
    function generateSemesters(startYear = 2026, count = FUTURE_SEMESTER_COUNT) {
      const out = [];
      let year = startYear;
      let isSpring = true; // start Spring startYear

      for (let i = 0; i < count; i++) {
        const label = (isSpring ? "Spring " : "Fall ") + year;
        out.push(label);
        if (!isSpring) year++; // after Fall, move to next year
        isSpring = !isSpring;
      }
      return out;
    }

    function semesterMonths(semesterLabel) {
      // returns { year: YYYY, months: [..] }
      const [season, yearStr] = semesterLabel.split(" ");
      const year = parseInt(yearStr, 10);
      if (season === "Spring") return { year, months: [1,2,3,4,5] };
      // Fall is always Aug-Dec of given year
      return { year, months: [8,9,10,11,12] };
    }

    /************** RENDER **************/
    const topRow = document.getElementById("topRow");
    const bottomRow = document.getElementById("bottomRow");
    const pageTitle = document.getElementById("pageTitle");
    const modeIndicator = document.getElementById("modeIndicator");

    // modes: "normal" | "addWeekends" | "grayOut"
    let mode = "normal";
    let currentSemester = null;

    function setMode(newMode) {
      mode = newMode;
      if (mode === "normal") {
        modeIndicator.style.display = "none";
      } else {
        modeIndicator.style.display = "inline-block";
        modeIndicator.textContent = mode === "addWeekends" ? "Mode: Add Weekends (click to toggle green). Press Esc to exit." :
                                                          "Mode: Gray Out (click to toggle gray). Press Esc to exit.";
      }
    }

    // placeholder empty five calendars
    function renderBlankFive() {
      topRow.innerHTML = "";
      bottomRow.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const m = document.createElement("div");
        m.className = "month";
        m.innerHTML = `
          <div class="month-title">—</div>
          <div class="day-names">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="days">${Array.from({length: 42}).map(()=>'<div class="day blank"></div>').join('')}</div>
        `;
        if (i < 3) topRow.appendChild(m);
        else bottomRow.appendChild(m);
      }
    }

    function createMonth(year, month) {
      const monthDiv = document.createElement("div");
      monthDiv.className = "month";
      const monthName = new Date(year, month - 1).toLocaleString("default", { month: "long" });
      monthDiv.innerHTML = `<div class="month-title">${monthName} ${year}</div>`;

      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const dayNamesDiv = document.createElement("div");
      dayNamesDiv.className = "day-names";
      dayNames.forEach(d => {
        const dn = document.createElement("div");
        dn.textContent = d;
        dayNamesDiv.appendChild(dn);
      });
      monthDiv.appendChild(dayNamesDiv);

      const daysDiv = document.createElement("div");
      daysDiv.className = "days";

      const firstDay = new Date(year, month - 1, 1).getDay();
      const numDays = new Date(year, month, 0).getDate();

      // leading blanks
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.className = "day blank";
        daysDiv.appendChild(emptyCell);
      }

      for (let day = 1; day <= numDays; day++) {
        const dateKey = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const weekday = new Date(year, month - 1, day).getDay();
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        dayDiv.textContent = day;

        // default weekends: Fri/Sat
        if (weekday === 5 || weekday === 6) {
          dayDiv.classList.add("weekend");
        }

        // weekend overrides (make any day green)
        if (weekendOverrides[dateKey]) {
          dayDiv.classList.add("weekend");
        }

        // grayouts (non-pickable unless in grayOut mode)
        if (grayouts[dateKey]) {
          dayDiv.classList.add("grayout", "unclickable");
        }

        // overlay mark
        const overlay = document.createElement("div");
        overlay.className = "overlay";
        const saved = markState[dateKey] || "";
        overlay.textContent = saved;
        if (saved === "/") overlay.classList.add("slash");
        else if (saved === "X") overlay.classList.add("x");
        dayDiv.appendChild(overlay);

        // click behavior depends on mode
        dayDiv.addEventListener("click", (event) => {
          // If in grayOut mode, allow toggling gray even if currently unclickable
          if (mode === "grayOut") {
            const isGray = !!grayouts[dateKey];
            if (isGray) {
              delete grayouts[dateKey];
              dayDiv.classList.remove("grayout", "unclickable");
            } else {
              grayouts[dateKey] = true;
              dayDiv.classList.add("grayout", "unclickable");
            }
            saveGrayouts();
            return;
          }

          // If in addWeekends mode, toggle green
          if (mode === "addWeekends") {
            const isCustomWeekend = !!weekendOverrides[dateKey];
            if (isCustomWeekend) {
              delete weekendOverrides[dateKey];
              // Recompute whether natural Fri/Sat should stay green
              const natural = (weekday === 5 || weekday === 6);
              if (!natural) dayDiv.classList.remove("weekend");
            } else {
              weekendOverrides[dateKey] = true;
              dayDiv.classList.add("weekend");
            }
            saveWends();
            return;
          }

          // Normal marking mode: do nothing if grayed-out
          if (dayDiv.classList.contains("unclickable")) return;

          const currentState = markState[dateKey] || "";
          const currentIndex = states.indexOf(currentState);

          let nextIndex;
          if ((currentState === "/" || currentState === "X") && !event.ctrlKey) {
            // Only allow clearing with Ctrl; otherwise advance until locked on X
            nextIndex = currentIndex === 2 ? 2 : currentIndex + 1;
          } else {
            nextIndex = (currentIndex + 1) % states.length;
          }

          const nextState = states[nextIndex];
          markState[dateKey] = nextState;

          overlay.textContent = nextState;
          overlay.className = "overlay";
          if (nextState === "/") overlay.classList.add("slash");
          else if (nextState === "X") overlay.classList.add("x");

          saveMarks();
        });

        daysDiv.appendChild(dayDiv);
      }

      monthDiv.appendChild(daysDiv);
      return monthDiv;
    }

    function renderSemester(semesterLabel) {
      const { year, months } = semesterMonths(semesterLabel);
      topRow.innerHTML = "";
      bottomRow.innerHTML = "";
      months.forEach((m, i) => {
        const cal = createMonth(year, m);
        if (i < 3) topRow.appendChild(cal);
        else bottomRow.appendChild(cal);
      });
      pageTitle.textContent = `RIT CRL Duty Pick — ${semesterLabel}`;
    }

    /************** CONTROLS **************/
    // Build semester list
    const semesterSelect = document.getElementById("semesterSelect");
    generateSemesters(2026, FUTURE_SEMESTER_COUNT).forEach(label => {
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      semesterSelect.appendChild(opt);
    });

    semesterSelect.addEventListener("change", (e) => {
      currentSemester = e.target.value;
      renderSemester(currentSemester);
      setMode("normal"); // exit any special mode on semester change
      actionsDropdown.value = "Options";
    });

    // Options dropdown
    const actionsDropdown = document.getElementById("actionsDropdown");
    actionsDropdown.addEventListener("change", function () {
      const v = this.value;

      if (v === "clear") {
        const confirmClear = confirm("Clear all slashes and Xs across ALL semesters? (Weekend/Gray settings remain.)");
        if (confirmClear) {
          markState = {};
          saveMarks();
          // re-render current view
          if (currentSemester) renderSemester(currentSemester);
        }
        this.value = "Options";
        return;
      }

      if (v === "addWeekends") {
        setMode(mode === "addWeekends" ? "normal" : "addWeekends");
        this.value = "Options";
        return;
      }

      if (v === "grayOut") {
        setMode(mode === "grayOut" ? "normal" : "grayOut");
        this.value = "Options";
        return;
      }
    });

    // ESC exits special modes
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && mode !== "normal") {
        setMode("normal");
      }
    });

    /************** INIT **************/
    renderBlankFive(); // blank on load
  </script>
</body>
</html>
